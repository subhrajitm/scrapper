<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LegalScrape Pro - Law Firm Data Extraction</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --surface: #fff;
      --border: #e1e4e8;
      --border-dark: #d0d4d9;
      --text: #24292f;
      --text-muted: #57606a;
      --text-light: #8b949e;
      --primary: #0969da;
      --primary-hover: #0860ca;
      --success: #1a7f37;
      --success-bg: #dafbe1;
      --danger: #cf222e;
      --danger-bg: #ffebe9;
      --header-bg: #24292f;
      --header-text: #f0f6fc;
      --accent: #8250df;
      --radius: 6px;
      --shadow: 0 1px 3px rgba(31,35,40,.12), 0 8px 24px rgba(66,74,83,.12);
      --shadow-sm: 0 1px 0 rgba(31,35,40,.04);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
    }
    /* Header */
    .header {
      background: var(--header-bg);
      padding: 0 16px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo {
      color: var(--header-text);
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo svg { fill: var(--header-text); }
    .nav { display: flex; gap: 4px; }
    .nav a {
      color: rgba(255,255,255,.7);
      text-decoration: none;
      font-size: 13px;
      padding: 6px 12px;
      border-radius: var(--radius);
      transition: all .15s;
    }
    .nav a:hover { color: #fff; background: rgba(255,255,255,.1); }
    .nav a.active { color: #fff; background: rgba(255,255,255,.15); }
    /* Main */
    .main { max-width: 1280px; margin: 0 auto; padding: 16px; }
    /* Search Panel */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
    }
    .panel-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .panel-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-body { padding: 16px; }
    /* Search Form */
    .search-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .form-group { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 180px; }
    .form-group label { font-size: 12px; font-weight: 500; color: var(--text-muted); }
    .form-control {
      height: 32px;
      padding: 0 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      background: var(--surface);
      color: var(--text);
      transition: border-color .15s, box-shadow .15s;
    }
    .form-control:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(9,105,218,.15); }
    select.form-control { cursor: pointer; }
    /* Buttons */
    .btn {
      height: 32px;
      padding: 0 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all .15s;
      white-space: nowrap;
      text-decoration: none;
    }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-default { background: var(--surface); color: var(--text); }
    .btn-default:hover:not(:disabled) { background: var(--bg); border-color: var(--border-dark); }
    .btn-primary { background: var(--primary); border-color: var(--primary); color: #fff; }
    .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }
    .btn-success { background: var(--success); border-color: var(--success); color: #fff; }
    .btn-success:hover:not(:disabled) { background: #15692e; }
    .btn-sm { height: 28px; padding: 0 10px; font-size: 12px; }
    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 500;
      border-radius: 10px;
      background: var(--bg);
      color: var(--text-muted);
    }
    .badge-primary { background: rgba(9,105,218,.1); color: var(--primary); }
    /* Alert */
    .alert {
      padding: 12px 16px;
      border-radius: var(--radius);
      font-size: 13px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .alert-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(207,34,46,.2); }
    /* Table */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border); }
    th { background: var(--bg); font-weight: 600; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .3px; position: sticky; top: 0; }
    tr:hover { background: #f6f8fa; }
    td { vertical-align: middle; }
    .table-check { width: 32px; text-align: center; }
    .table-check input { width: 14px; height: 14px; cursor: pointer; }
    .url-cell { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .url-cell a { color: var(--primary); text-decoration: none; }
    .url-cell a:hover { text-decoration: underline; }
    /* Toolbar */
    .toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 8px 12px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 8px; }
    .selected-count { font-size: 12px; color: var(--text-muted); }
    /* Pagination */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid var(--border);
    }
    .pagination-info { font-size: 12px; color: var(--text-muted); }
    /* Empty */
    .empty { text-align: center; padding: 48px 16px; color: var(--text-muted); }
    .empty-icon { font-size: 32px; margin-bottom: 8px; opacity: .5; }
    .empty h3 { font-size: 15px; color: var(--text); margin-bottom: 4px; }
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      overflow: auto;
    }
    .modal-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-title { font-size: 14px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 18px; cursor: pointer; color: var(--text-muted); padding: 4px; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 16px; }
    .modal-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
    textarea.form-control { height: auto; min-height: 100px; padding: 8px 12px; resize: vertical; }
    /* Responsive */
    @media (max-width: 768px) {
      .search-form { flex-direction: column; }
      .form-group { min-width: 100%; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .toolbar-left, .toolbar-right { justify-content: space-between; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <a href="/" class="logo">
        <svg width="20" height="20" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
        LegalScrape Pro
      </a>
      <nav class="nav">
        <a href="/" class="active">Search</a>
        <a href="#">History</a>
        <a href="#">Settings</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <!-- Search Panel -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M11.5 7a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0zm-.82 4.74a6 6 0 1 1 1.06-1.06l3.04 3.04a.75.75 0 1 1-1.06 1.06l-3.04-3.04z"/></svg>
          Find Law Firms
        </span>
        <button type="button" class="btn btn-sm btn-default" onclick="showModal('importModal')">Import List</button>
      </div>
      <div class="panel-body">
        <form method="post" class="search-form">
          <div class="form-group">
            <label for="practice_area">Practice Area</label>
            <select id="practice_area" name="practice_area" class="form-control" required>
              <option value="">Select area...</option>
              {% for area in practice_areas %}
              <option value="{{ area }}" {% if selected_practice_area == area %}selected{% endif %}>{{ area }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="location">Location</label>
            <input type="text" id="location" name="location" class="form-control" placeholder="City, State or Country" value="{{ (selected_city + ', ' + selected_state + ' ' + selected_country) | trim | replace(', ,', ',') | replace(' ,', '') }}">
          </div>
          <input type="hidden" name="city" value="{{ selected_city or '' }}">
          <input type="hidden" name="state" value="{{ selected_state or '' }}">
          <input type="hidden" name="country" value="{{ selected_country or '' }}">
          <input type="hidden" name="page" value="{{ page or 1 }}">
          <button type="submit" name="action" value="search" class="btn btn-primary">Search</button>
        </form>
      </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13zM0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm9 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-.25-6.25a.75.75 0 0 0-1.5 0v3.5a.75.75 0 0 0 1.5 0v-3.5z"/></svg>
      {{ error }}
    </div>
    {% endif %}

    <!-- Results Panel -->
    {% if websites %}
    <div class="panel">
      <div class="toolbar">
        <div class="toolbar-left">
          <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
          <label for="selectAll" style="font-size:12px;cursor:pointer;">Select All</label>
          <span class="selected-count" id="selectedCount">0 of {{ websites|length }} selected</span>
        </div>
        <div class="toolbar-right">
          <button type="button" class="btn btn-sm btn-success" onclick="startScrapeSelected()">Scrape Selected</button>
          <button type="button" class="btn btn-sm btn-primary" onclick="startScrapeAll()">Export All</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="table-check"></th>
              <th>#</th>
              <th>Website</th>
              <th>Domain</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            {% for site in websites %}
            <tr>
              <td class="table-check"><input type="checkbox" name="selected_urls" value="{{ site }}" onchange="updateSelectedCount()"></td>
              <td>{{ loop.index + (page - 1) * 10 }}</td>
              <td class="url-cell"><a href="{{ site }}" target="_blank" title="{{ site }}">{{ site | replace("https://", "") | replace("http://", "") | truncate(50, True, "...") }}</a></td>
              <td>{{ site | replace("https://", "") | replace("http://", "") | replace("www.", "") | truncate(30, True, "") }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if total_pages and total_pages > 1 %}
      <form method="post" class="pagination">
        <input type="hidden" name="practice_area" value="{{ selected_practice_area or '' }}">
        <input type="hidden" name="location" value="{{ selected_location or '' }}">
        <input type="hidden" name="city" value="{{ selected_city or '' }}">
        <input type="hidden" name="state" value="{{ selected_state or '' }}">
        <input type="hidden" name="country" value="{{ selected_country or '' }}">
        <input type="hidden" name="action" value="search">
        <button type="submit" name="page" value="{{ page - 1 }}" class="btn btn-sm btn-default" {% if page <= 1 %}disabled{% endif %}>Prev</button>
        <span class="pagination-info">Page {{ page }} of {{ total_pages }}</span>
        <button type="submit" name="page" value="{{ page + 1 }}" class="btn btn-sm btn-default" {% if page >= total_pages %}disabled{% endif %}>Next</button>
      </form>
      {% endif %}
    </div>
    {% elif selected_practice_area %}
    <div class="panel">
      <div class="empty">
        <div class="empty-icon">üì≠</div>
        <h3>No results found</h3>
        <p>Try adjusting your search criteria or location.</p>
      </div>
    </div>
    {% else %}
    <div class="panel">
      <div class="empty">
        <div class="empty-icon">üîç</div>
        <h3>Search for law firms</h3>
        <p>Select a practice area and location to get started.</p>
      </div>
    </div>
    {% endif %}
  </main>

  <!-- Import Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Import from External List</span>
        <button type="button" class="modal-close" onclick="hideModal('importModal')">&times;</button>
      </div>
      <form onsubmit="importFromList(event)">
        <div class="modal-body">
          <div class="form-group" style="margin-bottom:12px;">
            <label>List URL</label>
            <input type="url" id="listUrl" class="form-control" placeholder="https://example.com/top-law-firms">
          </div>
          <div class="form-group">
            <label>Or paste content</label>
            <textarea id="listText" class="form-control" placeholder="Paste law firm names or URLs..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" onclick="hideModal('importModal')">Cancel</button>
          <button type="submit" class="btn btn-primary">Import</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function showModal(id) { document.getElementById(id).classList.add('open'); }
    function hideModal(id) { document.getElementById(id).classList.remove('open'); }

    function updateSelectedCount() {
      const total = document.querySelectorAll('input[name="selected_urls"]').length;
      const checked = document.querySelectorAll('input[name="selected_urls"]:checked').length;
      document.getElementById('selectedCount').textContent = `${checked} of ${total} selected`;
      document.getElementById('selectAll').checked = checked === total && total > 0;
      document.getElementById('selectAll').indeterminate = checked > 0 && checked < total;
    }

    function toggleSelectAll(checked) {
      document.querySelectorAll('input[name="selected_urls"]').forEach(cb => cb.checked = checked);
      updateSelectedCount();
    }

    async function startJob(urls) {
      const res = await fetch('/api/start-scrape', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ urls })
      });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || 'Failed to start');
      return data.job_id;
    }

    async function startScrapeSelected() {
      const urls = Array.from(document.querySelectorAll('input[name="selected_urls"]:checked')).map(cb => cb.value);
      if (!urls.length) return alert('Please select at least one website.');
      try {
        const jobId = await startJob(urls);
        window.open(`/progress/${encodeURIComponent(jobId)}`, '_blank');
      } catch (e) { alert(e.message); }
    }

    async function startScrapeAll() {
      const urls = Array.from(document.querySelectorAll('input[name="selected_urls"]')).map(cb => cb.value);
      if (!urls.length) return alert('No websites to export.');
      try {
        const jobId = await startJob(urls);
        window.open(`/progress/${encodeURIComponent(jobId)}`, '_blank');
      } catch (e) { alert(e.message); }
    }

    async function importFromList(e) {
      e.preventDefault();
      const listUrl = document.getElementById('listUrl').value.trim();
      const listText = document.getElementById('listText').value.trim();
      if (!listUrl && !listText) return alert('Please provide a URL or paste content.');
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.textContent = 'Importing...';
      try {
        const res = await fetch('/import-list', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ listUrl, listText })
        });
        const data = await res.json();
        if (res.ok && data.success) {
          alert(`Found ${data.count} URL(s)`);
          hideModal('importModal');
        } else {
          alert(data.error || 'Import failed');
        }
      } catch (err) { alert(err.message); }
      finally { btn.disabled = false; btn.textContent = 'Import'; }
    }

    document.addEventListener('DOMContentLoaded', updateSelectedCount);
  </script>
</body>
</html>
