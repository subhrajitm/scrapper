<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Law Firm Finder</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #F8F8F8;
        color: #333;
        line-height: 1.6;
      }

      /* Navigation Bar */
      .navbar {
        background: white;
        padding: 10px 24px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 20px;
        font-weight: 700;
        color: #1a1a1a;
      }

      .nav-links {
        display: flex;
        gap: 20px;
        align-items: center;
        list-style: none;
      }

      .nav-links a {
        text-decoration: none;
        color: #666;
        font-size: 13px;
        transition: color 0.2s;
        position: relative;
      }

      .nav-links a:hover {
        color: #333;
      }

      .nav-links a.active {
        color: #4A90E2;
      }

      .nav-links a.active::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 2px;
        background: #4A90E2;
      }

      .nav-links .btn-register {
        background: #4A90E2;
        color: white;
        padding: 6px 16px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 13px;
      }

      .nav-links .btn-register:hover {
        background: #357ABD;
        color: white;
      }

      /* Hero Section */
      .hero {
        max-width: 1200px;
        margin: 30px auto;
        padding: 0 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: center;
      }

      .hero-content h1 {
        font-size: 36px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 12px;
        line-height: 1.2;
      }

      .hero-illustration {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .hero-illustration svg {
        width: 100%;
        max-width: 280px;
        height: auto;
      }

      /* Search Bar */
      .search-container {
        max-width: 1200px;
        margin: 0 auto 24px;
        padding: 0 24px;
      }

      .search-bar {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 6px;
        display: flex;
        align-items: center;
        gap: 0;
      }

      .search-field {
        flex: 1;
        display: flex;
        align-items: center;
        padding: 10px 14px;
        gap: 10px;
      }

      .search-field:not(:last-child) {
        border-right: 1px solid #E5E5E5;
      }

      .search-field-icon {
        color: #999;
        font-size: 20px;
      }

      .search-field input,
      .search-field select {
        border: none;
        outline: none;
        font-size: 14px;
        color: #333;
        width: 100%;
        background: transparent;
      }

      .search-field input::placeholder {
        color: #999;
      }

      .search-button {
        background: #4A90E2;
        color: white;
        border: none;
        padding: 10px 24px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }

      .search-button:hover {
        background: #357ABD;
      }

      /* Results Section */
      .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px 24px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 16px;
      }

      .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 20px;
      }

      .result-card {
        background: white;
        border-radius: 6px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .result-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .result-card.selected {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
      }

      .result-card.selected .result-title,
      .result-card.selected .result-url {
        color: white;
      }

      .result-card input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin-bottom: 8px;
        cursor: pointer;
      }

      .result-title {
        font-size: 16px;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 6px;
      }

      .result-url {
        font-size: 12px;
        color: #666;
        word-break: break-all;
      }

      .result-card.selected .result-url {
        color: rgba(255, 255, 255, 0.9);
      }

      /* Action Buttons */
      .action-bar {
        background: white;
        border-radius: 6px;
        padding: 12px 16px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .selection-info {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .btn {
        padding: 8px 18px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-secondary {
        background: #F0F0F0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #E0E0E0;
      }

      .btn-primary {
        background: #4A90E2;
        color: white;
      }

      .btn-primary:hover {
        background: #357ABD;
      }

      .btn-success {
        background: #48BB78;
        color: white;
      }

      .btn-success:hover {
        background: #38A169;
      }

      /* Error Message */
      .error-message {
        background: #FED7D7;
        color: #C53030;
        padding: 12px 20px;
        border-radius: 6px;
        margin: 16px auto;
        max-width: 1200px;
        border-left: 4px solid #C53030;
        font-size: 14px;
      }

      /* Progress Container */
      .progress-container {
        background: #F0FFF4;
        border: 2px solid #48BB78;
        border-radius: 6px;
        padding: 16px;
        margin: 16px auto;
        max-width: 1200px;
        display: none;
      }

      .progress-container.active {
        display: block;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .progress-title {
        font-size: 16px;
        font-weight: 700;
        color: #22543D;
      }

      .progress-status {
        font-size: 13px;
        color: #2F855A;
        font-weight: 500;
      }

      .progress-bar-container {
        width: 100%;
        height: 12px;
        background: #C6F6D5;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 12px;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #48BB78, #38A169);
        transition: width 0.3s ease;
        width: 0%;
      }

      .progress-details {
        font-size: 12px;
        color: #2F855A;
        margin-bottom: 8px;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
      }

      .pagination button {
        padding: 8px 16px;
        background: white;
        border: 1px solid #E5E5E5;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      .pagination button:hover:not(:disabled) {
        background: #F8F8F8;
        border-color: #4A90E2;
      }

      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .empty-state h3 {
        font-size: 20px;
        margin-bottom: 8px;
        color: #333;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .navbar {
          padding: 8px 16px;
          flex-wrap: wrap;
        }

        .nav-links {
          gap: 12px;
          font-size: 12px;
        }

        .hero {
          grid-template-columns: 1fr;
          margin: 20px auto;
          padding: 0 16px;
        }

        .hero-content h1 {
          font-size: 28px;
        }

        .search-container,
        .results-container {
          padding: 0 16px;
        }

        .search-bar {
          flex-direction: column;
        }

        .search-field:not(:last-child) {
          border-right: none;
          border-bottom: 1px solid #E5E5E5;
        }

        .results-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="logo">LawFirmFinder</div>
      <ul class="nav-links">
        <li><a href="#" class="active">Search</a></li>
        <li><a href="#">About</a></li>
        <li><a href="#">Contact</a></li>
        <li><a href="#" class="btn-register">Help</a></li>
      </ul>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-content">
        <h1>Find your perfect law firm</h1>
      </div>
      <div class="hero-illustration">
        <svg viewBox="0 0 400 300" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M200 50 L220 100 L180 100 Z" fill="#4A90E2" opacity="0.3"/>
          <circle cx="200" cy="150" r="40" fill="#4A90E2" opacity="0.2"/>
          <rect x="180" y="180" width="40" height="60" rx="4" fill="#4A90E2" opacity="0.4"/>
          <path d="M200 240 L200 280" stroke="#4A90E2" stroke-width="3" stroke-linecap="round"/>
          <circle cx="200" cy="280" r="8" fill="#4A90E2"/>
        </svg>
      </div>
    </section>

    <!-- Search Bar -->
    <div class="search-container">
      <form method="post" class="search-bar">
        <div class="search-field">
          <span class="search-field-icon">‚öñÔ∏è</span>
          <select id="practice_area" name="practice_area" required>
            <option value="">Practice Area</option>
            {% for area in practice_areas %}
            <option value="{{ area }}" {% if selected_practice_area == area %}selected{% endif %}>
              {{ area }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="search-field">
          <span class="search-field-icon">üìç</span>
          <input
            type="text"
            id="location"
            name="location"
            placeholder="City, State or Country"
            value="{{ (selected_city + ', ' + selected_state + ' ' + selected_country) | trim | replace(', ,', ',') | replace(' ,', '') }}"
          />
        </div>
        <button type="submit" name="action" value="search" class="search-button">
          Find it now
        </button>
        <button type="button" onclick="showListImporter()" class="search-button" style="background: #48BB78; margin-left: 8px;">
          üìã Import from List
        </button>
        <input type="hidden" name="city" value="{{ selected_city or '' }}" />
        <input type="hidden" name="state" value="{{ selected_state or '' }}" />
        <input type="hidden" name="country" value="{{ selected_country or '' }}" />
        <input type="hidden" name="page" value="{{ page or 1 }}" />
      </form>
    </div>

    {% if error %}
    <div class="error-message">
      ‚ö†Ô∏è {{ error }}
    </div>
    {% endif %}

    <div class="progress-container" id="progressContainer">
      <div class="progress-header">
        <div class="progress-title">Scraping in Progress</div>
        <div class="progress-status" id="progressStatus">Initializing...</div>
      </div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-details" id="progressDetails"></div>
    </div>

    <!-- Results Section -->
    {% if websites %}
    <div class="results-container">
      <div class="section-title">Latest Results:</div>

      <form method="post" id="scrapeForm">
        <input type="hidden" name="practice_area" value="{{ selected_practice_area or '' }}" />
        <input type="hidden" name="location" value="{{ selected_location or '' }}" />
        <input type="hidden" name="city" value="{{ selected_city or '' }}" />
        <input type="hidden" name="state" value="{{ selected_state or '' }}" />
        <input type="hidden" name="country" value="{{ selected_country or '' }}" />
        <input type="hidden" name="page" value="{{ page or 1 }}" />

        <div class="action-bar">
          <div class="selection-info">
            <button type="button" onclick="selectAll()" class="btn btn-secondary">Select All</button>
            <button type="button" onclick="deselectAll()" class="btn btn-secondary">Deselect All</button>
            <span id="selectedCount" style="color: #666; font-weight: 500;">0 selected</span>
          </div>
          <div>
            <button
              type="submit"
              name="action"
              value="scrape"
              class="btn btn-success"
              onclick="return confirmScrape()"
            >
              Scrape Selected
            </button>
            <button
              type="submit"
              name="action"
              value="export"
              class="btn btn-primary"
              style="margin-left: 12px;"
            >
              Export All
            </button>
          </div>
        </div>

        <div class="results-grid">
          {% for site in websites %}
          <div class="result-card" onclick="toggleCard(this)">
            <input
              type="checkbox"
              name="selected_urls"
              value="{{ site }}"
              onchange="updateSelectedCount(); toggleCardState(this)"
              style="display: none;"
            />
            <div class="result-title">
              {{ site | replace("https://", "") | replace("http://", "") | replace("www.", "") | truncate(40, True, "...") }}
            </div>
            <div class="result-url">{{ site }}</div>
          </div>
          {% endfor %}
        </div>

        {% if total_pages and total_pages > 1 %}
        <form method="post" class="pagination">
          <input type="hidden" name="practice_area" value="{{ selected_practice_area or '' }}" />
          <input type="hidden" name="location" value="{{ selected_location or '' }}" />
          <input type="hidden" name="city" value="{{ selected_city or '' }}" />
          <input type="hidden" name="state" value="{{ selected_state or '' }}" />
          <input type="hidden" name="country" value="{{ selected_country or '' }}" />
          <input type="hidden" name="action" value="search" />

          <button
            type="submit"
            name="page"
            value="{{ page - 1 }}"
            {% if page <= 1 %}disabled{% endif %}
          >
            Previous
          </button>
          <span style="padding: 8px 16px; color: #666; font-size: 13px;">
            Page {{ page }}{% if total_pages %} of {{ total_pages }}{% endif %}
          </span>
          <button
            type="submit"
            name="page"
            value="{{ page + 1 }}"
            {% if page >= total_pages %}disabled{% endif %}
          >
            Next
          </button>
        </form>
        {% endif %}
      </form>
    </div>
    {% elif selected_practice_area %}
    <div class="results-container">
      <div class="empty-state">
        <h3>No law firms found</h3>
        <p>Try adjusting your search criteria or location.</p>
      </div>
    </div>
    {% endif %}

    <script>
      function toggleCard(card) {
        const checkbox = card.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        updateCardState(card, checkbox.checked);
        updateSelectedCount();
      }

      function toggleCardState(checkbox) {
        const card = checkbox.closest('.result-card');
        updateCardState(card, checkbox.checked);
      }

      function updateCardState(card, isChecked) {
        if (isChecked) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      }

      function selectAll() {
        const checkboxes = document.querySelectorAll('input[name="selected_urls"]');
        checkboxes.forEach(cb => {
          cb.checked = true;
          updateCardState(cb.closest('.result-card'), true);
        });
        updateSelectedCount();
      }

      function deselectAll() {
        const checkboxes = document.querySelectorAll('input[name="selected_urls"]');
        checkboxes.forEach(cb => {
          cb.checked = false;
          updateCardState(cb.closest('.result-card'), false);
        });
        updateSelectedCount();
      }

      function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('input[name="selected_urls"]:checked');
        const count = checkboxes.length;
        document.getElementById('selectedCount').textContent = count + ' selected';
      }

      function confirmScrape() {
        const checkboxes = document.querySelectorAll('input[name="selected_urls"]:checked');
        if (checkboxes.length === 0) {
          alert('Please select at least one law firm to scrape.');
          return false;
        }
        document.getElementById('progressContainer').classList.add('active');
        startProgressPolling();
        return true;
      }

      function startProgressPolling() {
        const progressInterval = setInterval(async () => {
          try {
            const response = await fetch('/api/progress');
            const progress = await response.json();
            updateProgressUI(progress);
            
            if (progress.status === 'completed' || progress.status === 'error') {
              clearInterval(progressInterval);
              setTimeout(() => {
                document.getElementById('progressContainer').classList.remove('active');
              }, 5000);
            }
          } catch (error) {
            console.error('Error fetching progress:', error);
          }
        }, 1000);
      }

      function updateProgressUI(progress) {
        const percentage = progress.total > 0 
          ? Math.round((progress.completed / progress.total) * 100) 
          : 0;
        document.getElementById('progressBar').style.width = percentage + '%';
        
        const statusText = progress.status === 'running' 
          ? `Scraping... ${progress.completed}/${progress.total} completed`
          : progress.status === 'completed'
          ? `‚úÖ Completed! ${progress.completed}/${progress.total} websites`
          : progress.status === 'error'
          ? '‚ùå Error occurred'
          : 'Idle';
        document.getElementById('progressStatus').textContent = statusText;
        
        const details = progress.current_url 
          ? `Current: ${progress.current_url.substring(0, 50)}...`
          : progress.message || '';
        document.getElementById('progressDetails').textContent = details;
      }

      document.addEventListener('DOMContentLoaded', updateSelectedCount);

      // List Importer Modal
      function showListImporter() {
        document.getElementById('listImporterModal').style.display = 'flex';
      }

      function hideListImporter() {
        document.getElementById('listImporterModal').style.display = 'none';
        document.getElementById('listUrl').value = '';
        document.getElementById('listText').value = '';
      }

      async function importFromList(event) {
        event.preventDefault();
        const listUrl = document.getElementById('listUrl').value.trim();
        const listText = document.getElementById('listText').value.trim();
        
        if (!listUrl && !listText) {
          alert('Please provide either a list URL or paste the list text');
          return;
        }

        const importButton = event.target.querySelector('button[type="submit"]');
        const originalText = importButton.textContent;
        importButton.disabled = true;
        importButton.textContent = 'Importing...';

        try {
          const response = await fetch('/import-list', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ listUrl, listText }),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            alert(`Found ${data.count} law firm URL(s). You can now scrape them.`);
            // Optionally reload the page or update the UI with found URLs
            hideListImporter();
            if (data.urls && data.urls.length > 0) {
              // You could add these URLs to the search results or create a new form
              console.log('Imported URLs:', data.urls);
            }
          } else {
            alert('Error: ' + (data.error || 'Failed to import list'));
          }
        } catch (error) {
          alert('Error importing list: ' + error.message);
        } finally {
          importButton.disabled = false;
          importButton.textContent = originalText;
        }
      }
    </script>

    <!-- List Importer Modal -->
    <div id="listImporterModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 24px; border-radius: 8px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0; font-size: 20px; font-weight: 700;">Import from External List</h2>
          <button onclick="hideListImporter()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
        </div>
        <p style="color: #666; margin-bottom: 16px; font-size: 14px;">
          Import law firm URLs from external sources like WSJ Top Ten lists, SuperLawyers lists, etc.
        </p>
        <form onsubmit="importFromList(event)">
          <div style="margin-bottom: 16px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">List URL (optional):</label>
            <input type="url" id="listUrl" placeholder="https://example.com/top-law-firms-2025" style="width: 100%; padding: 10px; border: 1px solid #E5E5E5; border-radius: 6px; font-size: 14px;" />
          </div>
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Or paste list text:</label>
            <textarea id="listText" placeholder="Paste article content or list of law firm names/URLs here..." style="width: 100%; padding: 10px; border: 1px solid #E5E5E5; border-radius: 6px; font-size: 14px; min-height: 150px; resize: vertical;"></textarea>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="hideListImporter()" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Import URLs</button>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
